# dcc-app
DCC Flutter App

## Building
The project should be build with the flutter tool chain. **Only Android
build is supported at the moment.**

## Generating `freezed` files

We generate some classes via build runner and freezed.  These are *not* checked
into git and must be re-generated by running:

```sh
flutter pub run build_runner build
```

This is also needed if you change any of the classes annotated with
`@freezed`.

Note that Android studios may take a while at "understanding" that the
generation has taken place (as in a minute or two).

### Google Maps API key
Building the project requires a Google Maps API key which can be specified in
`android/local.properties` with the identifier `google.maps.key` or by setting
the `googleMapsApiKey` environment variable. If both are present
local.properties is used.

`android/local.properties` should be set as follows,

```ini
...
google.maps.key=<API-KEY>
```

### Making a release

To create a new release of the DCC mobile app, please perform the following steps:

 1. Update the `version:` in pubspec.yaml (e.g., `version: 3.2.1+1`).  The `+1` is a build number.
    At the moment, we do not use said build number, so just set it to 1.
    - If you are doing an ad-hoc version for a customer to verify something, **be sure** that the
      version indicates it is a pre-release (e.g., `3.2.1-alpha+1`) and that this pre-release
      has not been used before.  Save the `beta` and `rc` to "official" beta and release candidates
      releases.
 2. You may have to run "flutter pub get" and do a clean build to ensure the version is synchronized.
 3. Verify that the correct version shows in the footer of the Settings page.  It should say
    something like `dcc v3.2.1 (b1)` if the `version:` is set to `3.2.1+1` (as shown above)
    - This is important as if the version is wrong, we will get bug reports for the wrong version!
 5. Commit this change and get it merged (via PR).
    - This implies that the master is frozen during this time.  At the time of writing, freezing
      master is just ad-hoc coordinated.
 6. Checkout the merged commit and perform a production build (see *Build flavors* below)
 7. Rename the final artifact after its version (e.g., `dcc-v3.2.1_all_abis.apk`)
    - The file will be `build/app/outputs/flutter-apk/app-production-release.apk` (double check that
      the `Date modified` of the file matches when the build command finished)
 8. Tag the commit (e.g., `git tag v3.2.1`) and push it to github
 9. Create a release on github for that version and attach the produced APK to the release.
    - For final releases, you can generate the release notes from JIRA.  For pre-release ones,
      consider what makes sense to add when your fellow developer gets a bug report on this
      unofficial version.
 10. Bump the version in pubspec.yaml to indicate a dev version (e.g., `version: 3.2.2-dev+1`).
     Note we are bumping at minimum the "patch" part of the version.
 11. Commit and push/merge the bumped commit.
 12. Upload the artifact to google drive https://drive.google.com/drive/folders/1uWJB0kxA1NCcXvpuvhF8q8Eo7-XN0gdi
     - Note for unofficial builds, consider using a more "discrete" channel as that folder is available to *all*
       customers.
 13. Announce the new artefact to the (relevant) customers.

### Build flavors
We only have one flavour (`production`), but we should probably have a development as well at
some point.

When building with Flutter CLI, the build flavor should be specified using the `--flavor` argument:

```sh
flutter build apk --flavor production
```

If using Android Studio/Intellij, the build flavor should be specified in the
run configuration under `Build flavor`.

If you get a cryptic error a la:

```
Exception: Gradle build failed to produce an .apk file. It's likely that this file was generated under .../dcc-app/build, but the tool couldn't find it. APK not exist
```

Then check if you got the right flavour set.
